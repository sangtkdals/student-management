# Nginx 서버 블록 정의
server {
    # 80번 포트에서 요청을 수신
    listen 80;

    # 웹 서버의 루트 디렉토리 설정
    root /usr/share/nginx/html;
    # 기본으로 찾아볼 파일 (SPA를 위해 index.html을 기본으로 함)
    index index.html index.htm;

    # '/api'로 시작하는 모든 요청을 처리하는 location 블록
    location /api {
        # 이 요청을 백엔드 서비스로 전달(proxy)
        # 'backend'는 docker-compose.yml에 정의된 백엔드 서비스의 이름
        # Docker의 내부 DNS가 'backend'를 해당 컨테이너의 IP로 해석해 줌
        proxy_pass http://backend:8080;

        # 클라이언트의 원본 IP와 프로토콜 정보를 백엔드 서버로 전달하기 위한 헤더 설정
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 그 외의 모든 요청 (React 앱 자체에 대한 요청)을 처리하는 location 블록
    location / {
        # 요청된 URI에 해당하는 파일이 있는지 확인
        # 파일이 없으면 디렉토리인지 확인
        # 둘 다 없으면 /index.html을 대신 반환 (React Router가 클라이언트 사이드 라우팅을 처리하도록 함)
        try_files $uri $uri/ /index.html;
    }
}